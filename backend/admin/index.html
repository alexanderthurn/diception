<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Admin</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: left;
        }

        th {
            background-color: #f4f4f4;
        }

        button {
            cursor: pointer;
            padding: 5px 10px;
        }

        .delete-btn {
            background-color: #ff4444;
            color: white;
            border: none;
        }

        .preview-row td {
            background-color: #f9f9f9;
            padding: 20px;
        }

        pre {
            background: #eee;
            padding: 10px;
            margin-top: 10px;
            max-height: 400px;
            overflow: auto;
            font-size: 12px;
            display: block;
        }

        canvas {
            border: 1px solid #333;
            background: #000;
            display: block;
        }

        .config-panel {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
        }

        .config-panel h2 {
            margin-top: 0;
            font-size: 1.2em;
        }

        .config-item {
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <h1>Map Admin</h1>

    <div class="config-panel">
        <h2>Configuration</h2>
        <div class="config-item">
            <label>
                <input type="checkbox" id="allowUploadsCheckbox"> Allow Uploads
            </label>
        </div>
        <div class="config-item">
            Overwrite Mode:
            <label>
                <input type="radio" name="overwriteMode" value="replace"> Replace Existing (Same Name)
            </label>
            <label>
                <input type="radio" name="overwriteMode" value="new"> Always New (Modify Name)
            </label>
        </div>
        <button id="saveSettingsBtn">Save Settings</button>
    </div>

    <div id="status"></div>
    <div style="margin-bottom: 20px;">
        <input type="file" id="uploadInput" accept=".json" style="display: none;">
        <button onclick="document.getElementById('uploadInput').click()">Upload Map (JSON)</button>
    </div>

    <table id="mapTable">
        <thead>
            <tr>
                <th>Filename</th>
                <th>Name</th>
                <th>Author</th>
                <th>Type</th>
                <th>Size</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        const API_URL = '..'; // Relative to admin/
        let mapsData = [];

        // --- Settings Management ---
        async function fetchSettings() {
            try {
                const response = await fetch(`${API_URL}/get_settings.php`);
                const settings = await response.json();
                document.getElementById('allowUploadsCheckbox').checked = settings.allowUploads;
                document.querySelector(`input[name="overwriteMode"][value="${settings.overwriteMode}"]`).checked = true;
            } catch (error) {
                console.error('Error fetching settings:', error);
            }
        }

        document.getElementById('saveSettingsBtn').addEventListener('click', async () => {
            const settings = {
                allowUploads: document.getElementById('allowUploadsCheckbox').checked,
                overwriteMode: document.querySelector('input[name="overwriteMode"]:checked').value
            };

            try {
                const response = await fetch(`${API_URL}/update_settings.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                const result = await response.json();
                if (result.success) {
                    alert('Settings saved successfully!');
                } else {
                    alert('Failed to save settings: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error saving settings: ' + error.message);
            }
        });

        // --- Upload Logic ---
        document.getElementById('uploadInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (ev) => {
                try {
                    const json = JSON.parse(ev.target.result);
                    if (!json.name) {
                        alert("Missing 'name' in JSON file.");
                        return;
                    }
                    if (!json.tiles) {
                        if (!confirm("This doesn't look like a valid map (missing 'tiles'). Upload anyway?")) return;
                    }

                    const response = await fetch(`${API_URL}/upload.php`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(json)
                    });

                    const result = await response.json();
                    if (result.success) {
                        alert(result.message);
                        fetchMaps();
                    } else {
                        alert('Upload failed: ' + (result.error || 'Unknown error'));
                    }
                } catch (err) {
                    alert('Invalid JSON file');
                }
                e.target.value = '';
            };
            reader.readAsText(file);
        });

        async function fetchMaps() {
            try {
                const response = await fetch(`${API_URL}/list.php`);
                mapsData = await response.json();
                renderTable(mapsData);
            } catch (error) {
                console.error('Error fetching maps:', error);
                document.getElementById('status').textContent = 'Error loading maps.';
            }
        }

        function renderTable(maps) {
            const tbody = document.querySelector('#mapTable tbody');
            tbody.innerHTML = '';
            maps.forEach((map, index) => {
                const tr = document.createElement('tr');
                const safeFilename = (map.filename || '').replace(/'/g, "\\'");
                tr.innerHTML = `
                    <td>${map.filename || 'unknown'}</td>
                    <td>${map.name || 'Untitled'}</td>
                    <td>${map.author || 'Unknown'}</td>
                    <td>${map.type || 'map'}</td>
                    <td>${map.filesize || 0} bytes</td>
                    <td>${map.filemtime ? new Date(map.filemtime * 1000).toLocaleString() : 'Unknown'}</td>
                    <td>
                        <button onclick="togglePreview(${index}, this)">Preview</button>
                        <button class="delete-btn" onclick="deleteMap('${safeFilename}')">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function togglePreview(index, btn) {
            const row = btn.closest('tr');
            const nextRow = row.nextElementSibling;
            if (nextRow && nextRow.classList.contains('preview-row')) {
                nextRow.remove();
                return;
            }

            const mapData = mapsData[index];
            const previewRow = document.createElement('tr');
            previewRow.className = 'preview-row';
            const cell = document.createElement('td');
            cell.colSpan = 7;
            previewRow.appendChild(cell);
            row.after(previewRow);

            const canvas = document.createElement('canvas');
            const pre = document.createElement('pre');
            pre.textContent = JSON.stringify(mapData, null, 2);

            cell.appendChild(canvas);
            cell.appendChild(pre);

            renderCanvas(mapData, canvas);
        }

        function renderCanvas(mapData, canvas) {
            const ctx = canvas.getContext('2d');
            const tileSize = 20;
            const gap = 2;
            const width = mapData.width || 10;
            const height = mapData.height || 10;

            canvas.width = width * (tileSize + gap) + gap;
            canvas.height = height * (tileSize + gap) + gap;

            ctx.fillStyle = '#111';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const playerColors = {};
            if (mapData.players) {
                mapData.players.forEach(p => {
                    playerColors[p.id] = '#' + (p.color).toString(16).padStart(6, '0');
                });
            }

            if (mapData.tiles) {
                mapData.tiles.forEach(tile => {
                    const x = tile.x * (tileSize + gap) + gap;
                    const y = tile.y * (tileSize + gap) + gap;
                    let color = '#444';
                    if (tile.owner !== undefined && tile.owner !== -1 && playerColors[tile.owner]) {
                        color = playerColors[tile.owner];
                    }
                    ctx.fillStyle = color;
                    ctx.fillRect(x, y, tileSize, tileSize);
                    ctx.strokeStyle = 'rgba(255,255,255,0.2)';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(x, y, tileSize, tileSize);
                    if (tile.dice) {
                        ctx.fillStyle = '#fff';
                        ctx.font = 'bold 10px sans-serif';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(tile.dice, x + tileSize / 2, y + tileSize / 2 + 1);
                    }
                });
            }
        }

        async function deleteMap(filename) {
            if (!confirm(`Are you sure you want to delete ${filename}?`)) return;
            try {
                const response = await fetch(`${API_URL}/delete.php`, {
                    method: 'POST',
                    body: JSON.stringify({ filename })
                });
                const result = await response.json();
                if (result.success) {
                    fetchMaps();
                } else {
                    alert('Error deleting map: ' + result.error);
                }
            } catch (error) {
                alert('Error deleting map.');
            }
        }

        fetchSettings();
        fetchMaps();
    </script>
</body>

</html>